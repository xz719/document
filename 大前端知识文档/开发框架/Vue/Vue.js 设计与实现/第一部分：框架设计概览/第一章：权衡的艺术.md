# 第一章：权衡的艺术

> 框架的设计，本身就是一种权衡的艺术

## 1.1 命令式与声明式

* 命令式：关注过程
* 声明式：关注结果

**Vue.js 内部封装了命令式的过程，而向外暴露了声明式的接口。**

## 1.2 性能与可维护性的权衡

命令式代码与声明式代码的性能孰优孰劣？

命令式，我们直接编写实现功能的代码，其性能消耗为 1

声明式：内部是实现功能的代码，外部需要暴露出接口，供开发者使用。那么其性能消耗就是【外部调用接口的性能消耗 + 内部实现功能代码的性能消耗】，即 n + 1，这个 n 可能为 0，但绝不可能为负，所以我们可以得出结论：

**声明式代码的性能不优于命令式代码的性能！**

那么，为什么我们需要使用声明式代码？

因为，使用命令式时，我们需要维护实现目标的整个过程，而声明式代码则只需要关注结果，至于过程，框架已经替我们维护好了。所以这就是答案，声明式代码的可维护性高于命令式代码。

这实际上就体现了在框架设计上需要做出的关于性能与可维护性之间的权衡，而设计者需要做的就是：**在保持可维护性的同时让性能损失最小化**。

## 1.3 虚拟 DOM 的性能

这里不对虚拟 DOM 进行详细的探讨。

前面说到过，声明式代码的性能消耗为 n + 1，即外部操作消耗的性能 + 内部实现功能代码的性能消耗。那么，**如果我们能够最小化外部操作的性能消耗 n，就可以让声明式代码的性能无限接近于命令式代码的性能**，而这也是设计虚拟 DOM 的目的所在。

下面探讨一下虚拟 DOM 相比于原生 js 以及 innerHTML 的性能差异，分为三个方面：

1. 心智负担：原生 js > innerHTML > 虚拟 DOM
2. 可维护性：虚拟 DOM > innerHTML > 原生 js
3. 性能高低：原生 js > 虚拟 DOM > innerHTML

所谓心智负担，实际上是工作量的体现。

总体看来，虚拟 DOM 可以说是一个不错的选择。

## 1.4 运行时与编译时

这一部分，主要是探讨框架设计的三种选择：纯运行时、运行时 + 编译时以及纯编译时。

### 纯运行时

所谓纯运行时，以渲染 DOM 元素为例，实际上就是指，我们提供一个 Render 函数，将用户提供的用于描述 DOM 结构的树型结构数据对象，转化为真实的 DOM 结构。

比如：

```js
const obj =  {
    tag: 'div',
    children: [
        { tag: 'span', children: 'hello' },
    ]
}

// Render
function Render (obj, root) {
    const el = document.createElement(obj.tag);
    if (typeof obj.children === 'string') {
        const text = document.createTextNode(obj.children);
        el.appendChild(text);
    } else if (obj.children) {
        obj.children.forEach((child) => { Render(child, el) })
    }

    root.appendChild(el)
}
```

这样，用户不用学习额外的知识，就可以实现渲染 DOM 元素。这就是纯运行时的框架。

但是，如果用户觉得重复地手写树型结构数据对象过于繁琐呢？我们能不能引入编译的手段，让用户不用编写树型结构数据对象，而是直接用书写 HTML 的方式编写节点，然后我们再将 HTML 标签编译为树型结构数据对象，不就可以继续使用 Render 了吗？

### 运行时 + 编译时

为了达成上面的目的，我们又编写了一个 Compiler 的程序，其作用就是将 HTML 字符串编译为树型结构数据对象。用户在使用时只需要给出 HTML 字符串，然后调用 Compiler 方法和 Render 方法即可。

这就是一个运行时 + 编译时的框架。这种方式下，编译时分析用户提供的内容，运行时则提供了足够的灵活性。

### 纯编译时

既然编译器可以将 HTML 字符串编译为树型结构数据对象，那么能不能直接编译为命令式代码呢？

这样我们仅仅需要 Compiler 函数，不再需要 Render 函数了。这样就成了一个纯编译时的框架。这种方式，可以分析用户提供的内容，由于不存在运行时，理论上性能可能会更好。

### 总结

三种方向都有其优势，且业界均有探索。

Vue.js 仍然保持了运行时 + 编译时的架构，在保持灵活性的基础上尽可能优化，从而进一步提升性能。
